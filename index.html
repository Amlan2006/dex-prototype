<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RayVerse DEX</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.1/ethers.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #10b981;
            --background: #0f172a;
            --surface: #1e293b;
            --surface-light: #334155;
            --text: #f8fafc;
            --text-muted: #94a3b8;
            --border: #475569;
            --error: #ef4444;
            --success: #22c55e;
            --warning: #f59e0b;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            border-bottom: 1px solid var(--border);
            margin-bottom: 40px;
        }

        .logo {
            font-size: 28px;
            font-weight: bold;
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .wallet-section {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-primary {
            background: linear-gradient(45deg, var(--primary), var(--primary-dark));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(99, 102, 241, 0.3);
        }

        .btn-secondary {
            background: var(--surface-light);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--surface);
            transform: translateY(-1px);
        }

        /* Main Grid */
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }

        .card {
            background: var(--surface);
            border-radius: 20px;
            padding: 30px;
            border: 1px solid var(--border);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .card-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .swap-icon {
            background: linear-gradient(45deg, var(--primary), var(--secondary));
        }

        .liquidity-icon {
            background: linear-gradient(45deg, var(--secondary), var(--warning));
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-muted);
        }

        .form-input {
            width: 100%;
            padding: 15px;
            border: 1px solid var(--border);
            border-radius: 12px;
            background: var(--background);
            color: var(--text);
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .token-select {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .token-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 12px;
            background: var(--surface-light);
            color: var(--text);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .token-btn.active {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.1);
        }

        .swap-container {
            position: relative;
        }

        .swap-arrow {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            background: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 10;
        }

        .swap-arrow:hover {
            transform: translate(-50%, -50%) rotate(180deg);
            box-shadow: 0 5px 15px rgba(99, 102, 241, 0.4);
        }

        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: var(--surface);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid var(--border);
            text-align: center;
        }

        .stat-value {
            font-size: 28px;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 8px;
        }

        .stat-label {
            color: var(--text-muted);
            font-size: 14px;
        }

        /* Notifications */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 12px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: var(--success);
        }

        .notification.error {
            background: var(--error);
        }

        .notification.info {
            background: var(--primary);
        }

        /* Loading States */
        .loading {
            opacity: 0.7;
            pointer-events: none;
        }

        .spinner {
            border: 2px solid var(--border);
            border-top: 2px solid var(--primary);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 15px;
            }
            
            .header {
                flex-direction: column;
                gap: 20px;
            }
            
            .wallet-section {
                width: 100%;
                justify-content: center;
            }
        }

        /* Animations */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in-up {
            animation: fadeInUp 0.6s ease-out;
        }

        /* Price Display */
        .price-display {
            background: rgba(99, 102, 241, 0.1);
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
            font-size: 14px;
            color: var(--text-muted);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="logo">ðŸŒŸ RayVerse DEX</div>
            <div class="wallet-section">
                <button class="btn btn-secondary" id="connectWallet">Connect Wallet</button>
                <div id="walletInfo" style="display: none;">
                    <span id="walletAddress"></span>
                    <button class="btn btn-secondary" id="disconnectWallet">Disconnect</button>
                </div>
            </div>
        </header>

        <!-- Stats Grid -->
        <div class="stats-grid">
            <div class="stat-card fade-in-up">
                <div class="stat-value" id="rayverseLiquidity">0</div>
                <div class="stat-label">RAY Liquidity</div>
            </div>
            <div class="stat-card fade-in-up">
                <div class="stat-value" id="sonarTakaLiquidity">0</div>
                <div class="stat-label">STK Liquidity</div>
            </div>
            <div class="stat-card fade-in-up">
                <div class="stat-value" id="rayverseBalance">0</div>
                <div class="stat-label">Your RAY Balance</div>
            </div>
            <div class="stat-card fade-in-up">
                <div class="stat-value" id="sonarTakaBalance">0</div>
                <div class="stat-label">Your STK Balance</div>
            </div>
        </div>

        <!-- Main Grid -->
        <div class="main-grid">
            <!-- Swap Section -->
            <div class="card fade-in-up">
                <div class="card-title">
                    <div class="card-icon swap-icon">â‡„</div>
                    Swap Tokens
                </div>
                
                <div class="swap-container">
                    <div class="form-group">
                        <label class="form-label">From</label>
                        <div class="token-select">
                            <button class="token-btn active" data-token="ray">RAY</button>
                            <button class="token-btn" data-token="stk">STK</button>
                        </div>
                        <input type="number" class="form-input" id="swapFromAmount" placeholder="0.0" min="0" step="0.01">
                    </div>
                    
                    <div class="swap-arrow" id="swapDirection">â†“</div>
                    
                    <div class="form-group">
                        <label class="form-label">To</label>
                        <div class="price-display" id="swapPreview">Enter amount to see preview</div>
                        <input type="number" class="form-input" id="swapToAmount" placeholder="0.0" readonly>
                    </div>
                </div>
                
                <button class="btn btn-primary" id="executeSwap" style="width: 100%; margin-top: 20px;">
                    Swap Tokens
                </button>
            </div>

            <!-- Liquidity Section -->
            <div class="card fade-in-up">
                <div class="card-title">
                    <div class="card-icon liquidity-icon">ðŸ’§</div>
                    Manage Liquidity
                </div>
                
                <div class="token-select" style="margin-bottom: 20px;">
                    <button class="token-btn active" data-action="add">Add Liquidity</button>
                    <button class="token-btn" data-action="remove">Remove Liquidity</button>
                </div>
                
                <div id="liquidityForms">
                    <!-- Add Liquidity Form -->
                    <div id="addLiquidityForm">
                        <div class="form-group">
                            <label class="form-label">Token</label>
                            <div class="token-select">
                                <button class="token-btn active" data-liquidity-token="ray">RAY</button>
                                <button class="token-btn" data-liquidity-token="stk">STK</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Amount</label>
                            <input type="number" class="form-input" id="liquidityAmount" placeholder="0.0" min="0" step="0.01">
                        </div>
                        <button class="btn btn-primary" id="addLiquidity" style="width: 100%;">
                            Add Liquidity
                        </button>
                    </div>
                    
                    <!-- Remove Liquidity Form -->
                    <div id="removeLiquidityForm" style="display: none;">
                        <div class="form-group">
                            <label class="form-label">Token</label>
                            <div class="token-select">
                                <button class="token-btn active" data-remove-token="ray">RAY</button>
                                <button class="token-btn" data-remove-token="stk">STK</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Amount</label>
                            <input type="number" class="form-input" id="removeAmount" placeholder="0.0" min="0" step="0.01">
                        </div>
                        <button class="btn btn-primary" id="removeLiquidity" style="width: 100%;">
                            Remove Liquidity
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Initialize Pool Section -->
        <div class="card fade-in-up">
            <div class="card-title">
                <div class="card-icon" style="background: linear-gradient(45deg, var(--warning), var(--error));">ðŸš€</div>
                Initialize Pool (One-time setup)
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div class="form-group">
                    <label class="form-label">RAY Amount</label>
                    <input type="number" class="form-input" id="initRayAmount" placeholder="100" min="0" step="0.01">
                </div>
                <div class="form-group">
                    <label class="form-label">STK Amount</label>
                    <input type="number" class="form-input" id="initStkAmount" placeholder="100" min="0" step="0.01">
                </div>
            </div>
            
            <button class="btn btn-primary" id="initializePool" style="width: 100%;">
                Initialize Pool
            </button>
        </div>
    </div>

    <script>
        // Global variables
        let provider = null;
        let signer = null;
        let dexContract = null;
        let rayverseContract = null;
        let sonarTakaContract = null;
        let userAddress = null;

        // Contract addresses (you'll need to update these with your deployed addresses)
        const DEX_ADDRESS = "0x77c7E3905c21177Be97956c6620567596492C497";
        const RAYVERSE_ADDRESS = "0x7ef8E99980Da5bcEDcF7C10f41E55f759F6A174B";
        const SONARTAKA_ADDRESS = "0x82B769500E34362a76DF81150e12C746093D954F";

        // Contract ABI (simplified - you'll need the full ABIs)
        const DEX_ABI = [
            "function initializeLiquidity(uint256 _rayverseAmount, uint256 _sonarTakaAmount) external",
            "function addLiquidityForRayverse(uint256 amount) external",
            "function addLiquidityForSonarTaka(uint256 amount) external",
            "function removeLiquidityForRayverse(uint256 amount) external",
            "function removeLiquidityForSonarTaka(uint256 amount) external",
            "function swapRayverseToSonarTaka(uint256 amount) external returns (uint256)",
            "function swapSonarTakaToRayverse(uint256 amount) external returns (uint256)",
            "function checkRayverseLiquidity() external view returns (uint256)",
            "function checkSonarTakaLiquidity() external view returns (uint256)",
            "function checkPriceRayverseToSonarTaka(uint256 amount) external view returns (uint256)",
            "function checkPriceSonarTakaToRayverse(uint256 amount) external view returns (uint256)"
        ];

        const TOKEN_ABI = [
            "function balanceOf(address account) external view returns (uint256)",
            "function approve(address spender, uint256 amount) external returns (bool)",
            "function allowance(address owner, address spender) external view returns (uint256)",
            "function decimals() external view returns (uint8)"
        ];

        // State variables
        let swapFromToken = 'ray';
        let liquidityToken = 'ray';
        let removeToken = 'ray';
        let liquidityAction = 'add';

        // Initialize the app
        async function init() {
            setupEventListeners();
            if (window.ethereum) {
                await checkConnection();
            } else {
                showNotification('Please install MetaMask to use this DEX', 'error');
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Wallet connection
            document.getElementById('connectWallet').addEventListener('click', connectWallet);
            document.getElementById('disconnectWallet').addEventListener('click', disconnectWallet);

            // Swap functionality
            document.querySelectorAll('[data-token]').forEach(btn => {
                btn.addEventListener('click', (e) => selectSwapToken(e.target.dataset.token));
            });
            
            document.getElementById('swapDirection').addEventListener('click', swapTokens);
            document.getElementById('swapFromAmount').addEventListener('input', updateSwapPreview);
            document.getElementById('executeSwap').addEventListener('click', executeSwap);

            // Liquidity functionality
            document.querySelectorAll('[data-action]').forEach(btn => {
                btn.addEventListener('click', (e) => selectLiquidityAction(e.target.dataset.action));
            });

            document.querySelectorAll('[data-liquidity-token]').forEach(btn => {
                btn.addEventListener('click', (e) => selectLiquidityToken(e.target.dataset.liquidityToken));
            });

            document.querySelectorAll('[data-remove-token]').forEach(btn => {
                btn.addEventListener('click', (e) => selectRemoveToken(e.target.dataset.removeToken));
            });

            document.getElementById('addLiquidity').addEventListener('click', addLiquidity);
            document.getElementById('removeLiquidity').addEventListener('click', removeLiquidity);
            document.getElementById('initializePool').addEventListener('click', initializePool);
        }

        // Wallet connection functions
        async function connectWallet() {
            try {
                if (!window.ethereum) {
                    throw new Error('MetaMask not found');
                }

                await window.ethereum.request({ method: 'eth_requestAccounts' });
                
                // Create provider with ENS disabled for local networks
                const network = await window.ethereum.request({ method: 'eth_chainId' });
                const chainId = parseInt(network, 16);
                
                // For local networks (Hardhat, Ganache), disable ENS
                if (chainId === 31337 || chainId === 1337) {
                    provider = new ethers.BrowserProvider(window.ethereum, {
                        name: "localhost",
                        chainId: chainId,
                        ensAddress: null
                    });
                } else {
                    provider = new ethers.BrowserProvider(window.ethereum);
                }
                
                signer = await provider.getSigner();
                userAddress = await signer.getAddress();

                // Initialize contracts
                dexContract = new ethers.Contract(DEX_ADDRESS, DEX_ABI, signer);
                rayverseContract = new ethers.Contract(RAYVERSE_ADDRESS, TOKEN_ABI, signer);
                sonarTakaContract = new ethers.Contract(SONARTAKA_ADDRESS, TOKEN_ABI, signer);

                updateWalletUI();
                await updateStats();
                showNotification(`Wallet connected successfully! Network: ${chainId}`, 'success');
            } catch (error) {
                console.error('Error connecting wallet:', error);
                showNotification('Failed to connect wallet: ' + error.message, 'error');
            }
        }

        async function checkConnection() {
            try {
                const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                if (accounts.length > 0) {
                    await connectWallet();
                }
            } catch (error) {
                console.error('Error checking connection:', error);
                // Don't show error notification for connection check
            }
        }

        function disconnectWallet() {
            provider = null;
            signer = null;
            dexContract = null;
            rayverseContract = null;
            sonarTakaContract = null;
            userAddress = null;
            
            updateWalletUI();
            showNotification('Wallet disconnected', 'info');
        }

        function updateWalletUI() {
            const connectBtn = document.getElementById('connectWallet');
            const walletInfo = document.getElementById('walletInfo');
            const walletAddress = document.getElementById('walletAddress');

            if (userAddress) {
                connectBtn.style.display = 'none';
                walletInfo.style.display = 'flex';
                walletAddress.textContent = `${userAddress.slice(0, 6)}...${userAddress.slice(-4)}`;
            } else {
                connectBtn.style.display = 'block';
                walletInfo.style.display = 'none';
            }
        }

        // Stats update functions
        async function updateStats() {
            if (!dexContract) return;

            try {
                const rayLiquidity = await dexContract.checkRayverseLiquidity();
                const stkLiquidity = await dexContract.checkSonarTakaLiquidity();
                
                document.getElementById('rayverseLiquidity').textContent = 
                    (Number(ethers.formatEther(rayLiquidity))).toFixed(2);
                document.getElementById('sonarTakaLiquidity').textContent = 
                    (Number(ethers.formatEther(stkLiquidity))).toFixed(2);

                if (userAddress) {
                    const rayBalance = await rayverseContract.balanceOf(userAddress);
                    const stkBalance = await sonarTakaContract.balanceOf(userAddress);
                    
                    document.getElementById('rayverseBalance').textContent = 
                        (Number(ethers.formatEther(rayBalance))).toFixed(2);
                    document.getElementById('sonarTakaBalance').textContent = 
                        (Number(ethers.formatEther(stkBalance))).toFixed(2);
                }
            } catch (error) {
                console.error('Error updating stats:', error);
            }
        }

        // Swap functionality
        function selectSwapToken(token) {
            document.querySelectorAll('[data-token]').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-token="${token}"]`).classList.add('active');
            swapFromToken = token;
            updateSwapPreview();
        }

        function swapTokens() {
            const fromTokens = document.querySelectorAll('[data-token]');
            const activeToken = document.querySelector('[data-token].active');
            
            if (activeToken.dataset.token === 'ray') {
                selectSwapToken('stk');
            } else {
                selectSwapToken('ray');
            }
            
            // Clear amounts
            document.getElementById('swapFromAmount').value = '';
            document.getElementById('swapToAmount').value = '';
            updateSwapPreview();
        }

        async function updateSwapPreview() {
            const amount = document.getElementById('swapFromAmount').value;
            const previewDiv = document.getElementById('swapPreview');
            const toAmountInput = document.getElementById('swapToAmount');

            if (!amount || !dexContract || amount <= 0) {
                previewDiv.textContent = 'Enter amount to see preview';
                toAmountInput.value = '';
                return;
            }

            try {
                let outputAmount;
                if (swapFromToken === 'ray') {
                    outputAmount = await dexContract.checkPriceRayverseToSonarTaka(amount);
                } else {
                    outputAmount = await dexContract.checkPriceSonarTakaToRayverse(amount);
                }

                const formattedOutput = Number(ethers.formatEther(outputAmount)).toFixed(6);
                const feeAmount = (formattedOutput * 0.003).toFixed(6);
                const finalAmount = (formattedOutput - feeAmount).toFixed(6);

                previewDiv.innerHTML = `
                    Output: ${formattedOutput}<br>
                    Fee (0.3%): ${feeAmount}<br>
                    You receive: ${finalAmount}
                `;
                
                toAmountInput.value = finalAmount;
            } catch (error) {
                previewDiv.textContent = 'Unable to calculate preview';
                toAmountInput.value = '';
            }
        }

        async function executeSwap() {
            if (!dexContract || !signer) {
                showNotification('Please connect your wallet first', 'error');
                return;
            }

            const amount = document.getElementById('swapFromAmount').value;
            if (!amount || amount <= 0) {
                showNotification('Please enter a valid amount', 'error');
                return;
            }

            try {
                const btn = document.getElementById('executeSwap');
                btn.classList.add('loading');
                btn.innerHTML = '<span class="spinner"></span>Processing...';

                // Check and approve tokens if needed
                const tokenContract = swapFromToken === 'ray' ? rayverseContract : sonarTakaContract;
                const amountWei = ethers.parseEther(amount);
                
                const allowance = await tokenContract.allowance(userAddress, DEX_ADDRESS);
                if (allowance < amountWei) {
                    showNotification('Approving tokens...', 'info');
                    const approveTx = await tokenContract.approve(DEX_ADDRESS, amountWei);
                    await approveTx.wait();
                }

                // Execute swap
                let swapTx;
                if (swapFromToken === 'ray') {
                    swapTx = await dexContract.swapRayverseToSonarTaka(amount);
                } else {
                    swapTx = await dexContract.swapSonarTakaToRayverse(amount);
                }

                await swapTx.wait();
                
                showNotification('Swap successful!', 'success');
                await updateStats();
                
                // Clear inputs
                document.getElementById('swapFromAmount').value = '';
                document.getElementById('swapToAmount').value = '';
                updateSwapPreview();

            } catch (error) {
                console.error('Swap error:', error);
                showNotification('Swap failed: ' + error.message, 'error');
            } finally {
                const btn = document.getElementById('executeSwap');
                btn.classList.remove('loading');
                btn.innerHTML = 'Swap Tokens';
            }
        }

        // Liquidity functionality
        function selectLiquidityAction(action) {
            document.querySelectorAll('[data-action]').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-action="${action}"]`).classList.add('active');
            liquidityAction = action;

            const addForm = document.getElementById('addLiquidityForm');
            const removeForm = document.getElementById('removeLiquidityForm');

            if (action === 'add') {
                addForm.style.display = 'block';
                removeForm.style.display = 'none';
            } else {
                addForm.style.display = 'none';
                removeForm.style.display = 'block';
            }
        }

        function selectLiquidityToken(token) {
            document.querySelectorAll('[data-liquidity-token]').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-liquidity-token="${token}"]`).classList.add('active');
            liquidityToken = token;
        }

        function selectRemoveToken(token) {
            document.querySelectorAll('[data-remove-token]').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-remove-token="${token}"]`).classList.add('active');
            removeToken = token;
        }

        async function addLiquidity() {
            if (!dexContract || !signer) {
                showNotification('Please connect your wallet first', 'error');
                return;
            }

            const amount = document.getElementById('liquidityAmount').value;
            if (!amount || amount <= 0) {
                showNotification('Please enter a valid amount', 'error');
                return;
            }

            try {
                const btn = document.getElementById('addLiquidity');
                btn.classList.add('loading');
                btn.innerHTML = '<span class="spinner"></span>Adding...';

                // Check and approve tokens if needed
                const tokenContract = liquidityToken === 'ray' ? rayverseContract : sonarTakaContract;
                const amountWei = ethers.parseEther(amount);
                
                const allowance = await tokenContract.allowance(userAddress, DEX_ADDRESS);
                if (allowance < amountWei) {
                    showNotification('Approving tokens...', 'info');
                    const approveTx = await tokenContract.approve(DEX_ADDRESS, amountWei);
                    await approveTx.wait();
                }

                // Add liquidity
                let liquidityTx;
                if (liquidityToken === 'ray') {
                    liquidityTx = await dexContract.addLiquidityForRayverse(amount);
                } else {
                    liquidityTx = await dexContract.addLiquidityForSonarTaka(amount);
                }

                await liquidityTx.wait();
                
                showNotification('Liquidity added successfully!', 'success');
                await updateStats();
                
                // Clear input
                document.getElementById('liquidityAmount').value = '';

            } catch (error) {
                console.error('Add liquidity error:', error);
                showNotification('Failed to add liquidity: ' + error.message, 'error');
            } finally {
                const btn = document.getElementById('addLiquidity');
                btn.classList.remove('loading');
                btn.innerHTML = 'Add Liquidity';
            }
        }

        async function removeLiquidity() {
            if (!dexContract || !signer) {
                showNotification('Please connect your wallet first', 'error');
                return;
            }

            const amount = document.getElementById('removeAmount').value;
            if (!amount || amount <= 0) {
                showNotification('Please enter a valid amount', 'error');
                return;
            }

            try {
                const btn = document.getElementById('removeLiquidity');
                btn.classList.add('loading');
                btn.innerHTML = '<span class="spinner"></span>Removing...';

                // Remove liquidity
                let removeTx;
                if (removeToken === 'ray') {
                    removeTx = await dexContract.removeLiquidityForRayverse(amount);
                } else {
                    removeTx = await dexContract.removeLiquidityForSonarTaka(amount);
                }

                await removeTx.wait();
                
                showNotification('Liquidity removed successfully!', 'success');
                await updateStats();
                
                // Clear input
                document.getElementById('removeAmount').value = '';

            } catch (error) {
                console.error('Remove liquidity error:', error);
                showNotification('Failed to remove liquidity: ' + error.message, 'error');
            } finally {
                const btn = document.getElementById('removeLiquidity');
                btn.classList.remove('loading');
                btn.innerHTML = 'Remove Liquidity';
            }
        }

        async function initializePool() {
            if (!dexContract || !signer) {
                showNotification('Please connect your wallet first', 'error');
                return;
            }

            const rayAmount = document.getElementById('initRayAmount').value;
            const stkAmount = document.getElementById('initStkAmount').value;

            if (!rayAmount || !stkAmount || rayAmount <= 0 || stkAmount <= 0) {
                showNotification('Please enter valid amounts for both tokens', 'error');
                return;
            }

            try {
                const btn = document.getElementById('initializePool');
                btn.classList.add('loading');
                btn.innerHTML = '<span class="spinner"></span>Initializing...';

                // Convert to proper units (the contract expects the base amount, not wei)
                const rayAmountWei = ethers.parseEther(rayAmount);
                const stkAmountWei = ethers.parseEther(stkAmount);

                showNotification('Checking allowances...', 'info');
                
                // Check and approve RAY tokens
                const rayAllowance = await rayverseContract.allowance(userAddress, DEX_ADDRESS);
                if (rayAllowance < rayAmountWei) {
                    showNotification('Approving RAY tokens...', 'info');
                    const rayApproveTx = await rayverseContract.approve(DEX_ADDRESS, rayAmountWei);
                    await rayApproveTx.wait();
                }

                // Check and approve STK tokens
                const stkAllowance = await sonarTakaContract.allowance(userAddress, DEX_ADDRESS);
                if (stkAllowance < stkAmountWei) {
                    showNotification('Approving STK tokens...', 'info');
                    const stkApproveTx = await sonarTakaContract.approve(DEX_ADDRESS, stkAmountWei);
                    await stkApproveTx.wait();
                }

                // Initialize pool - pass the base amount (contract multiplies by 1e18)
                showNotification('Initializing pool...', 'info');
                const initTx = await dexContract.initializeLiquidity(
                    ethers.parseUnits(rayAmount, 0), // Convert to integer
                    ethers.parseUnits(stkAmount, 0)  // Convert to integer
                );
                await initTx.wait();
                
                showNotification('Pool initialized successfully!', 'success');
                await updateStats();
                
                // Clear inputs
                document.getElementById('initRayAmount').value = '';
                document.getElementById('initStkAmount').value = '';

            } catch (error) {
                console.error('Initialize pool error:', error);
                let errorMessage = 'Failed to initialize pool';
                
                if (error.message.includes('Already initialized')) {
                    errorMessage = 'Pool is already initialized';
                } else if (error.message.includes('Insufficient')) {
                    errorMessage = 'Insufficient token balance or allowance';
                } else if (error.reason) {
                    errorMessage = `Failed: ${error.reason}`;
                } else if (error.message) {
                    errorMessage = `Failed: ${error.message}`;
                }
                
                showNotification(errorMessage, 'error');
            } finally {
                const btn = document.getElementById('initializePool');
                btn.classList.remove('loading');
                btn.innerHTML = 'Initialize Pool';
            }
        }

        // Utility functions
        function showNotification(message, type) {
            // Remove existing notifications
            const existing = document.querySelector('.notification');
            if (existing) {
                existing.remove();
            }

            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);

            // Show notification
            setTimeout(() => notification.classList.add('show'), 100);

            // Hide notification after 5 seconds
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 5000);
        }

        // Auto-refresh stats every 30 seconds
        setInterval(() => {
            if (dexContract) {
                updateStats();
            }
        }, 30000);

        // Listen for account changes
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', (accounts) => {
                if (accounts.length === 0) {
                    disconnectWallet();
                } else {
                    connectWallet();
                }
            });

            window.ethereum.on('chainChanged', () => {
                window.location.reload();
            });
        }

        // Initialize the app when page loads
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>